name: Deploy to GCP

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: gitguide-backend
  REGION: us-central1
  GAR_LOCATION: us-central1-docker.pkg.dev
  AR_REPO: gitguide
  CLOUD_RUN_RUNTIME_SA: gemini-api-service@gitguide-backend.iam.gserviceaccount.com

jobs:
  ci:
    name: Lint (Pre-commit handles tests)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Ruff check
        run: uv run ruff check .

      - name: Ruff format check
        run: uv run ruff format --check .

  deploy-cloud-run:
    name: Build + Deploy Cloud Run
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build + Push API image
        run: |
          docker build -t ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/api:${{ github.sha }} .
          docker push ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/api:${{ github.sha }}

      - name: Build + Push Roadmap image
        run: |
          docker build -f Dockerfile.roadmap -t ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/roadmap:${{ github.sha }} .
          docker push ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/roadmap:${{ github.sha }}

      - name: Deploy API (Cloud Run)
        id: deploy-api
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: gitguide-api
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/api:${{ github.sha }}
          timeout: 600
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=1
            --max-instances=10
            --min-instances=0
            --service-account=${{ env.CLOUD_RUN_RUNTIME_SA }}
          env_vars: |
            APP_MODULE=app.main:app
            ENVIRONMENT=production
            GCP_PROJECT_ID=${{ env.PROJECT_ID }}
            GCP_LOCATION=${{ env.REGION }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            QDRANT_URL=${{ secrets.QDRANT_URL }}
            QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}
            CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            ROADMAP_SERVICE_URL=${{ secrets.ROADMAP_SERVICE_URL }}
            INTERNAL_AUTH_TOKEN=${{ secrets.INTERNAL_AUTH_TOKEN }}

      - name: Deploy Roadmap (Cloud Run)
        id: deploy-roadmap
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: gitguide-roadmap
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/roadmap:${{ github.sha }}
          timeout: 600
          flags: |
            --no-allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --max-instances=5
            --min-instances=0
            --service-account=${{ env.CLOUD_RUN_RUNTIME_SA }}
          env_vars: |
            APP_MODULE=app.roadmap_service:app
            ENVIRONMENT=production
            GCP_PROJECT_ID=${{ env.PROJECT_ID }}
            GCP_LOCATION=${{ env.REGION }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            QDRANT_URL=${{ secrets.QDRANT_URL }}
            QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}
            CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
            GROQ_API_KEY2=${{ secrets.GROQ_API_KEY2 }}
            INTERNAL_AUTH_TOKEN=${{ secrets.INTERNAL_AUTH_TOKEN }}
            GCP_SA_KEY=${{ secrets.GCP_SA_KEY }}

      - name: Wait for Cloud Run revisions
        run: |
          set -e
          echo "Waiting for API service..."
          API_READY=0
          for i in $(seq 1 30); do
            STATUS=$(gcloud run services describe gitguide-api --region=${{ env.REGION }} --format='value(status.conditions[0].status)' 2>/dev/null || echo "UNKNOWN")
            if [ "$STATUS" = "True" ]; then echo "API ready."; API_READY=1; break; fi
            echo "Attempt $i/30: API status $STATUS"
            sleep 10
          done
          [ "$API_READY" -eq 1 ] || (echo "API service did not become ready"; exit 1)
          echo "Waiting for Roadmap service..."
          ROADMAP_READY=0
          for i in $(seq 1 30); do
            STATUS=$(gcloud run services describe gitguide-roadmap --region=${{ env.REGION }} --format='value(status.conditions[0].status)' 2>/dev/null || echo "UNKNOWN")
            if [ "$STATUS" = "True" ]; then echo "Roadmap ready."; ROADMAP_READY=1; break; fi
            echo "Attempt $i/30: Roadmap status $STATUS"
            sleep 10
          done
          [ "$ROADMAP_READY" -eq 1 ] || (echo "Roadmap service did not become ready"; exit 1)

      - name: Health check (API)
        run: |
          API_URL=$(gcloud run services describe gitguide-api --region=${{ env.REGION }} --format='value(status.url)')
          echo "Checking $API_URL/api/health ..."
          for i in $(seq 1 12); do
            if curl -sf "$API_URL/api/health" > /dev/null; then
              echo "API health check OK"
              exit 0
            fi
            echo "Attempt $i/12: waiting 10s..."
            sleep 10
          done
          echo "API health check failed"
          exit 1

      - name: Health check (Roadmap revision)
        run: |
          REV=$(gcloud run revisions list --service=gitguide-roadmap --region=${{ env.REGION }} --limit=1 --format='value(metadata.name)' 2>/dev/null)
          if [ -z "$REV" ]; then echo "No roadmap revision found"; exit 1; fi
          echo "Latest Roadmap revision: $REV"
          gcloud run revisions describe "$REV" --region=${{ env.REGION }} --format='value(status.conditions[0].status)' | grep -q True

      - name: Log deployment summary
        if: always()
        run: |
          echo "=== API ==="
          gcloud run services describe gitguide-api --region=${{ env.REGION }} --format='value(status.url)' || true
          gcloud run revisions list --service=gitguide-api --region=${{ env.REGION }} --limit=1 --format='table(metadata.name,status.conditions[0].status)' || true
          echo "=== Roadmap ==="
          gcloud run services describe gitguide-roadmap --region=${{ env.REGION }} --format='value(status.url)' || true
          gcloud run revisions list --service=gitguide-roadmap --region=${{ env.REGION }} --limit=1 --format='table(metadata.name,status.conditions[0].status)' || true

  deploy-workspace-vm:
    name: Deploy Workspace VM
    runs-on: ubuntu-latest
    needs: deploy-cloud-run
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - name: Deploy to Workspace VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            set -e
            cd /opt/gitguide-backend
            git fetch origin main && git reset --hard origin/main

            # Fix permissions on venv if needed, then sync
            if [ -d .venv ]; then
              sudo chown -R $USER:$USER .venv 2>/dev/null || true
              find .venv -type d -name __pycache__ -exec sudo rm -rf {} + 2>/dev/null || true
            fi

            source .venv/bin/activate
            uv sync --frozen || uv sync
            sudo systemctl restart gitguide-workspaces
            echo "VM deploy complete."

      - name: Health check (Workspace VM service)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            for i in 1 2 3 4 5 6; do
              if systemctl is-active --quiet gitguide-workspaces; then
                echo "gitguide-workspaces is active"
                exit 0
              fi
              echo "Waiting for service... ($i/6)"
              sleep 5
            done
            echo "gitguide-workspaces failed to become active"
            systemctl status gitguide-workspaces || true
            exit 1
