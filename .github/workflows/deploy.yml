name: Deploy to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  PROJECT_ID: gitguide-backend
  REGION: us-central1
  GAR_LOCATION: us-central1-docker.pkg.dev
  AR_REPO: gitguide
  CLOUD_RUN_RUNTIME_SA: gemini-api-service@gitguide-backend.iam.gserviceaccount.com

jobs:
  deploy-cloud-run:
    name: Build + Deploy Cloud Run
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
        # NOTE: Service account must have "Artifact Registry Writer" role
        # Grant with: gcloud projects add-iam-policy-binding gitguide-backend \
        #   --member="serviceAccount:SERVICE_ACCOUNT_EMAIL" \
        #   --role="roles/artifactregistry.writer"

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build + Push API image
        run: |
          docker build -t ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/api:${{ github.sha }} .
          docker push ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/api:${{ github.sha }}

      - name: Build + Push Roadmap image
        run: |
          docker build -f Dockerfile.roadmap -t ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/roadmap:${{ github.sha }} .
          docker push ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/roadmap:${{ github.sha }}

      - name: Deploy API (Cloud Run)
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: gitguide-api
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/api:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --memory=1Gi
            --cpu=1
            --timeout=300
            --max-instances=10
            --min-instances=0
            --service-account=${{ env.CLOUD_RUN_RUNTIME_SA }}
          env_vars: |
            ENVIRONMENT=production
            GCP_PROJECT_ID=${{ env.PROJECT_ID }}
            GCP_LOCATION=${{ env.REGION }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            QDRANT_URL=${{ secrets.QDRANT_URL }}
            QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}
            CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            # Add any other env vars you need:
            # CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
            # REDIS_URL=${{ secrets.REDIS_URL }}

      - name: Deploy Roadmap (Cloud Run)
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: gitguide-roadmap
          region: ${{ env.REGION }}
          image: ${{ env.GAR_LOCATION }}/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/roadmap:${{ github.sha }}
          flags: |
            --no-allow-unauthenticated
            --memory=2Gi
            --cpu=2
            --timeout=900
            --max-instances=5
            --min-instances=0
            --service-account=${{ env.CLOUD_RUN_RUNTIME_SA }}
          env_vars: |
            ENVIRONMENT=production
            GCP_PROJECT_ID=${{ env.PROJECT_ID }}
            GCP_LOCATION=${{ env.REGION }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            SUPABASE_SERVICE_KEY=${{ secrets.SUPABASE_SERVICE_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            QDRANT_URL=${{ secrets.QDRANT_URL }}
            QDRANT_API_KEY=${{ secrets.QDRANT_API_KEY }}
            CLERK_SECRET_KEY=${{ secrets.CLERK_SECRET_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}

      - name: Show Cloud Run URLs
        run: |
          echo "API URL:"
          gcloud run services describe gitguide-api --region=${{ env.REGION }} --format='value(status.url)'
          echo "Roadmap URL:"
          gcloud run services describe gitguide-roadmap --region=${{ env.REGION }} --format='value(status.url)'

  # ============================================
  # Deploy to Workspace VM
  # ============================================
  deploy-workspace-vm:
    name: Deploy to Workspace VM
    runs-on: ubuntu-latest
    needs: deploy-cloud-run

    steps:
      - name: Deploy to Workspace VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          script: |
            cd /opt/gitguide-backend
            git pull origin main
            source .venv/bin/activate
            uv pip install -r pyproject.toml
            sudo systemctl restart gitguide-workspaces
            echo "Deployment complete!"
